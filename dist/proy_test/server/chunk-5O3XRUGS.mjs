import './polyfills.server.mjs';
import{a as U,b as k,r as w}from"./chunk-NAQTD7QE.mjs";import{r as T}from"./chunk-3XZ7VEHP.mjs";import{I as l,Ma as d,N as u,S as v,T as c,j as o,n as i,ta as b,v as a}from"./chunk-UUTS3HRG.mjs";import{a as g,b as m}from"./chunk-5XUXGTUW.mjs";var S={production:!0,urlDominioApi:"http://localhost:8000",urlRaiz:"http://localhost:8000/api",apiUrl:"http://localhost:8000/api"};var h=class s{http=c(k);baseUrl=`${S.urlRaiz}`;getHeaders(){return new U({"Content-Type":"application/json",Accept:"application/json"})}get(e){return this.http.get(`${this.baseUrl}/${e}`,{headers:this.getHeaders()})}post(e,t){return this.http.post(`${this.baseUrl}/${e}`,t,{headers:this.getHeaders()})}put(e,t){return this.http.put(`${this.baseUrl}/${e}`,t,{headers:this.getHeaders()})}delete(e){return this.http.delete(`${this.baseUrl}/${e}`,{headers:this.getHeaders()})}static \u0275fac=function(t){return new(t||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var n=class extends Error{};n.prototype.name="InvalidTokenError";function A(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function I(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return A(e)}catch{return atob(e)}}function y(s,e){if(typeof s!="string")throw new n("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new n(`Invalid token specified: missing part #${t+1}`);let f;try{f=I(r)}catch(p){throw new n(`Invalid token specified: invalid base64 for part #${t+1} (${p.message})`)}try{return JSON.parse(f)}catch(p){throw new n(`Invalid token specified: invalid json for part #${t+1} (${p.message})`)}}var O=class s{TOKEN_KEY="auth_token";USER_KEY="auth_user";apiService=c(h);router=c(w);isBrowser;isAuthenticated=d(!1);currentUser=d(null);constructor(e){this.isBrowser=T(e),this.isBrowser&&(this.isAuthenticated.set(this.hasValidToken()),this.currentUser.set(this.getUserFromStorage()))}login(e){return this.apiService.post("auth/login",e).pipe(l(t=>{if(t.status==="success"){this.storeToken(t.data.authorization);let r=this.getUserFromToken();r?(this.storeUser(r),this.currentUser.set(r)):(this.storeUser(t.data.user),this.currentUser.set(t.data.user)),this.isAuthenticated.set(!0)}}),i(t=>t.status==="success"),a(()=>o(!1)))}register(e){return this.apiService.post("auth/register",e).pipe(l(t=>{if(t.status==="success"){this.storeToken(t.data.authorization);let r=this.getUserFromToken();r?(this.storeUser(r),this.currentUser.set(r)):(this.storeUser(t.data.user),this.currentUser.set(t.data.user)),this.isAuthenticated.set(!0)}}),i(t=>t.status==="success"),a(()=>o(!1)))}logout(){return this.isAuthenticated()?this.apiService.post("auth/logout",{}).pipe(l(()=>this.clearAuth()),i(()=>!0),a(()=>(this.clearAuth(),o(!0)))):(this.clearAuth(),o(!0))}refreshToken(){return this.apiService.post("auth/refresh",{}).pipe(l(e=>{e.status==="success"&&this.storeToken(e.data.authorization)}),i(e=>e.status==="success"),a(()=>o(!1)))}loadProfile(){return this.apiService.get("auth/profile").pipe(l(e=>{e.status==="success"&&e.data.user&&(this.storeUser(e.data.user),this.currentUser.set(e.data.user))}),i(e=>e.data.user),a(()=>o(null)))}forgotPassword(e){return this.apiService.post("auth/forgot-password",{email:e}).pipe(i(t=>t),a(t=>{throw console.error("Error enviando correo de recuperaci\xF3n:",t),t}))}validateResetToken(e,t){return this.apiService.post("auth/validate-reset-token",{token:e,email:t}).pipe(i(r=>r),a(r=>{throw console.error("Error validando token:",r),r}))}resetPassword(e){return this.apiService.post("auth/reset-password",e).pipe(i(t=>t),a(t=>{throw console.error("Error restableciendo contrase\xF1a:",t),t}))}clearAuth(){this.isBrowser&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)),this.isAuthenticated.set(!1),this.currentUser.set(null),this.router.navigate(["/auth/login"])}storeToken(e){this.isBrowser&&localStorage.setItem(this.TOKEN_KEY,JSON.stringify(m(g({},e),{expires_at:new Date().getTime()+e.expires_in*1e3})))}storeUser(e){e&&this.isBrowser&&localStorage.setItem(this.USER_KEY,JSON.stringify(e))}getToken(){if(!this.isBrowser)return null;try{let e=localStorage.getItem(this.TOKEN_KEY);return e?JSON.parse(e).access_token:null}catch{return null}}getUserFromStorage(){if(!this.isBrowser)return null;try{let e=this.getUserFromToken();if(e)return e;let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}catch{return null}}hasValidToken(){if(!this.isBrowser)return!1;try{let e=localStorage.getItem(this.TOKEN_KEY);if(!e)return!1;let t=JSON.parse(e);return t.expires_at&&new Date().getTime()>t.expires_at?(this.clearAuth(),!1):!0}catch{return this.clearAuth(),!1}}getUserFromToken(){if(!this.isBrowser)return null;try{let e=this.getToken();if(!e)return null;let t=y(e);return t&&t.id&&t.name&&t.email&&t.rol?{id:t.id,name:t.name,email:t.email,rol:t.rol,created_at:t.created_at||"",updated_at:t.updated_at||""}:null}catch(e){return console.error("Error al decodificar el token JWT",e),null}}static \u0275fac=function(t){return new(t||s)(v(b))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{S as a,O as b};
